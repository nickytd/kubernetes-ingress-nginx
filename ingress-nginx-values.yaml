## nginx configuration
## Ref: https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/index.md
##
controller:
  extraContainers:
    - name: filebeat
      image: docker.elastic.co/beats/filebeat-oss:7.10.2
      args:
        - -c
        - /usr/share/filebeat/filebeat.yml
        - -e
      env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
      resources:
        requests:
          memory: 50Mi
        limits:
          memory: 150Mi        
      volumeMounts:
        - name: nginx-log
          mountPath: /var/log/nginx
        - name: filebeat-config
          mountPath: /usr/share/filebeat/filebeat.yml
          subPath: filebeat.yml

        
  extraVolumeMounts:
    - name: nginx-log
      mountPath: /var/log/nginx

  extraVolumes:
    - name: nginx-log
      emptyDir: {}  
    - name: filebeat-config
      configMap:
        defaultMode: 420
        name: filebeat-nginx-config    

  extraArgs:
    alsologtostderr: true
    ingress-class: nginx
  
  hostPort:
    enabled: true
    enableHttp: true
    enableHttps: true

    ports:
      http: 80
      https: 443
    
    targetPorts:
      http: http
      https: https
  
  service:
    type: NodePort
    nodePorts:
      http: 32080
      https: 32443

  admissionWebhooks:
    enabled: false
      
  metrics:
    enabled: true
    
    serviceMonitor:
      enabled: true
      namespaceSelector:
        any: true

    prometheusRule:
      enabled: false
      rules:
        #These are just examples rules, please adapt them to your needs
        - alert: NGINXConfigFailed
          expr: count(nginx_ingress_controller_config_last_reload_successful == 0) > 0
          for: 1s
          labels:
            severity: critical
          annotations:
            description: bad ingress config - nginx config test failed
            summary: uninstall the latest ingress changes to allow config reloads to resume
        - alert: NGINXCertificateExpiry
          expr: (avg(nginx_ingress_controller_ssl_expire_time_seconds) by (host) - time()) < 604800
          for: 1s
          labels:
            severity: critical
          annotations:
            description: ssl certificate(s) will expire in less then a week
            summary: renew expiring certificates to avoid downtime
        - alert: NGINXTooMany500s
          expr: 100 * ( sum( nginx_ingress_controller_requests{status=~"5.+"} ) / sum(nginx_ingress_controller_requests) ) > 5
          for: 1m
          labels:
            severity: warning
          annotations:
            description: Too many 5XXs
            summary: More than 5% of all requests returned 5XX, this requires your attention
        - alert: NGINXTooMany400s
          expr: 100 * ( sum( nginx_ingress_controller_requests{status=~"4.+"} ) / sum(nginx_ingress_controller_requests) ) > 5
          for: 1m
          labels:
            severity: warning
          annotations:
            description: Too many 4XXs
            summary: More than 5% of all requests returned 4XX, this requires your attention    